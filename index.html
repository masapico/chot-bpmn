<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flow Canvas</title>

    <link rel="stylesheet" href="./lib/diagram-js.css" />
    <link rel="stylesheet" href="./lib/bpmn-embedded.css" />

    <link rel="stylesheet" href="./lib/bootstrap.min.css" />
    <style>
      /* 基本的なレイアウト */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        overflow: hidden; /* スクロールバーを隠す */
      }
      #bpmn-container {
        width: 100%;
        height: 100%;
        background-color: #f8f9fa; /* 少し明るい背景色に変更 */
        position: relative; /* djs-containerの親としてposition指定 */
      }
      /* フローティングボタンのコンテナ */
      .floating-buttons {
        position: fixed;
        bottom: 20px;
        left: 20px; /* Changed from right to left */
        right: auto; /* Added to ensure left positioning overrides right */
        z-index: 100;
        background-color: #f0f0f0; /* Light grey background for the container */
        padding: 8px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: flex; /* Horizontal layout for buttons */
        gap: 8px; /* Spacing between buttons */
      }
      .floating-buttons .btn {
        font-size: 1.2rem; /* Kept for potential future use, though SVG size is fixed */
        width: 40px; /* Fixed width for square-ish buttons */
        height: 40px; /* Fixed height for square-ish buttons */
        padding: 0; /* Remove default bootstrap padding */
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ccc; /* Subtle border for buttons */
        background-color: #fff; /* White background for buttons */
        color: #333; /* Icon color, will be inherited by SVG fill="currentColor" */
        border-radius: 6px; /* Slightly rounded corners for buttons */
      }
      .floating-buttons .btn:hover {
        background-color: #e9e9e9; /* Hover effect */
        border-color: #bbb;
      }

      .floating-buttons .btn svg {
        /* Style for SVGs within buttons */
        width: 20px;
        height: 20px;
      }

      /* エラーメッセージ */
      #error-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 2000;
        display: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      #error-message .close-error {
        color: white;
        text-decoration: none;
        margin-left: 15px;
        font-weight: bold;
        cursor: pointer;
      }

      /* --- パンくずリストのスタイル調整 --- */
      #bpmn-container .bjs-breadcrumbs {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: #fafafa;
        border-bottom: solid 1px #ccc;
        padding: 6px 10px;
        list-style: none;
        margin: 0;
        z-index: 10;
        box-sizing: border-box;
        font-size: 13px;
        line-height: 1.4;
      }

      #bpmn-container .bjs-breadcrumbs li {
        display: inline-block;
        margin-right: 5px;
      }
      #bpmn-container .bjs-breadcrumbs li:not(:last-child)::after {
        content: ">";
        margin-left: 8px;
        margin-right: 3px;
        color: #555;
      }

      #bpmn-container .bjs-breadcrumbs li a,
      #bpmn-container .bjs-breadcrumbs li span {
        color: #333;
        text-decoration: none;
      }
      #bpmn-container .bjs-breadcrumbs li a:hover {
        color: #155cb5;
        text-decoration: underline;
      }

      /* --- エディタ背景のグリッドスタイル --- */
      #bpmn-container .djs-container .layer-djs-grid rect {
        /* fill: url(#djs-grid-pattern-dots); */ /* SVGパターンを使う場合 */
        fill: none; /* デフォルトのグリッドパターンを無効化する場合 */
      }
      #bpmn-container .djs-container {
        /* CSSでグリッド背景を生成 */
        background-image: linear-gradient(
            to right,
            #e0e0e0 1px,
            transparent 1px
          ),
          linear-gradient(to bottom, #e0e0e0 1px, transparent 1px);
        background-size: 20px 20px; /* グリッドの間隔 */
      }

      .bjs-breadcrumbs {
        text-align: center;
      }
      .bjs-crumb {
        font-size: 1rem;
      }
      .djs-palette {
        top: 50px;
      }
      .bjs-powered-by {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="bpmn-container"></div>

    <div class="floating-buttons">
      <button id="btn-import-bpmn" class="btn" title="BPMN読込 (.bpmn)">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="currentColor"
          class="bi bi-folder2-open"
          viewBox="0 0 16 16"
        >
          <path
            d="M1 3.5A1.5 1.5 0 0 1 2.5 2h2.764c.973 0 1.942.372 2.684 1.054L10.5 5.5H14.5A1.5 1.5 0 0 1 16 7v5.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 12.5V4.964A1.5 1.5 0 0 1 1 3.5zM2 6h12v-.5a.5.5 0 0 0-.5-.5H9.828a.5.5 0 0 1-.354-.146l-.943-.943A.5.5 0 0 0 8.172 4H2.5a.5.5 0 0 0-.5.5V6zm-1 7v-5.5A1.5 1.5 0 0 1 2.5 6h11A1.5 1.5 0 0 1 15 7.5V13a1 1 0 0 1-1 1H1.5a1 1 0 0 1-1-1z"
          />
        </svg>
      </button>
      <button id="btn-create-new" class="btn" title="新規作成">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="currentColor"
          class="bi bi-plus-lg"
          viewBox="0 0 16 16"
        >
          <path
            fill-rule="evenodd"
            d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"
          />
        </svg>
      </button>
      <button id="btn-export-bpmn" class="btn" title="BPMN出力 (.bpmn)">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="currentColor"
          class="bi bi-download"
          viewBox="0 0 16 16"
        >
          <path
            d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
          />
          <path
            d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"
          />
        </svg>
      </button>
      <button id="btn-show-svg" class="btn" title="SVG表示 (別タブ)">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="currentColor"
          class="bi bi-image"
          viewBox="0 0 16 16"
        >
          <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
          <path
            d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"
          />
        </svg>
      </button>
      <button id="btn-export-svg" class="btn" title="SVGエクスポート (.svg)">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="currentColor"
          class="bi bi-file-earmark-image"
          viewBox="0 0 16 16"
        >
          <path d="M6.502 7a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z" />
          <path
            d="M14 14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5V14zM4 1a1 1 0 0 0-1 1v10l2.224-2.224a.5.5 0 0 1 .61-.075L8 11l2.157-3.02a.5.5 0 0 1 .76-.063L13 10V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4z"
          />
        </svg>
      </button>
      <input
        type="file"
        id="file-input-bpmn"
        style="display: none"
        accept=".bpmn, .xml"
      />
    </div>

    <div id="error-message">
      <span id="error-text"></span>
      <a class="close-error" id="close-error-btn">&times; 閉じる</a>
    </div>

    <script src="./lib/bpmn-modeler.development.js"></script>

    <script>
      const initialDiagramXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" targetNamespace="http://bpmn.io/schema/bpmn" id="Definitions_1" name="Default Process">
  <bpmn:process id="Process_1" name="Main" isExecutable="false">
    <bpmn:startEvent id="StartEvent_1" name="開始"/>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
        <dc:Bounds height="36.0" width="36.0" x="173.0" y="102.0"/>
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

      let modeler;
      let djsContainerObserver;
      let breadcrumbsShownProcessed = false;

      const bpmnContainer = document.getElementById("bpmn-container");
      const btnCreateNew = document.getElementById("btn-create-new");
      const btnExportBpmn = document.getElementById("btn-export-bpmn");
      const btnImportBpmn = document.getElementById("btn-import-bpmn");
      const fileInputBpmn = document.getElementById("file-input-bpmn");
      const btnShowSvg = document.getElementById("btn-show-svg");
      const btnExportSvg = document.getElementById("btn-export-svg");

      const errorMessageDiv = document.getElementById("error-message");
      const errorTextSpan = document.getElementById("error-text");
      const closeErrorBtn = document.getElementById("close-error-btn");

      function showError(message) {
        errorTextSpan.textContent = message;
        errorMessageDiv.style.display = "block";
        console.error(message);
      }

      function clearError() {
        errorMessageDiv.style.display = "none";
        errorTextSpan.textContent = "";
      }
      closeErrorBtn.onclick = clearError;

      function downloadFile(filename, data, type) {
        const blob = new Blob([data], { type });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      }

      function fitViewport() {
        if (!modeler) return;
        const canvas = modeler.get("canvas");
        if (canvas) {
          try {
            if (canvas.getRootElement()) {
              canvas.zoom("fit-viewport", "auto");
              console.log(
                "ビューポートをフィットさせました。対象:",
                canvas.getRootElement().id
              );
            } else {
              console.warn(
                "ルート要素が見つからないため、ビューポートのフィットをスキップしました。"
              );
            }
          } catch (e) {
            console.error("ビューポートフィットに失敗:", e);
            showError(`ビューの調整に失敗しました: ${e.message || e}`);
          }
        }
      }

      function fitViewportWithDelay(delay = 250) {
        console.log(`ビューポート調整を ${delay}ms 遅延実行します。`);
        setTimeout(fitViewport, delay);
      }

      function initializeModeler() {
        clearError();
        modeler = new BpmnJS({
          container: bpmnContainer,
          keyboard: { bindTo: window },
        });

        modeler
          .importXML(initialDiagramXML)
          .then(() => {
            console.log("初期ダイアグラムが正常に読み込まれました。");
            fitViewport();
            breadcrumbsShownProcessed = false;

            const canvasInternal = modeler.get("canvas");
            if (canvasInternal && canvasInternal._container) {
              const djsContainerElement = canvasInternal._container;
              console.log(
                "djs-containerの監視を開始します:",
                djsContainerElement
              );

              djsContainerObserver = new MutationObserver((mutationsList) => {
                for (const mutation of mutationsList) {
                  if (
                    mutation.type === "attributes" &&
                    mutation.attributeName === "class"
                  ) {
                    const targetElement = mutation.target;
                    const classList = targetElement.classList;
                    if (classList.contains("bjs-breadcrumbs-shown")) {
                      if (!breadcrumbsShownProcessed) {
                        console.log(
                          "bjs-breadcrumbs-shown クラスが検出されました。(初回)"
                        );
                        breadcrumbsShownProcessed = true;
                        const breadcrumbsULElement =
                          djsContainerElement.querySelector(
                            "ul.bjs-breadcrumbs"
                          );
                        if (breadcrumbsULElement) {
                          console.log(
                            "パンくずリスト要素 (<ul.bjs-breadcrumbs>) が見つかりました。innerHTML:",
                            breadcrumbsULElement.innerHTML
                          );
                        } else {
                          console.warn(
                            "bjs-breadcrumbs-shownクラスはありますが、<ul.bjs-breadcrumbs> 要素が見つかりません。"
                          );
                        }
                        fitViewportWithDelay();
                      }
                    } else {
                      if (breadcrumbsShownProcessed) {
                        console.log(
                          "bjs-breadcrumbs-shown クラスが削除されました。フラグをリセットします。"
                        );
                        breadcrumbsShownProcessed = false;
                      }
                    }
                  }
                }
              });
              djsContainerObserver.observe(djsContainerElement, {
                attributes: true,
              });
            } else {
              console.warn(
                "djs-containerの監視設定に失敗しました。canvas._containerが見つかりません。"
              );
            }
          })
          .catch((err) => {
            showError(
              `初期ダイアグラムの読み込みに失敗: ${err.message || err}`
            );
          });

        modeler.on("root.changed", (event) => {
          const { newRoot } = event;
          console.log("ルート要素が変更されました:", newRoot.id);
          breadcrumbsShownProcessed = false;
          fitViewportWithDelay();
        });

        const breadcrumbsModule = modeler.get("breadcrumbs", false);
        if (breadcrumbsModule) {
          breadcrumbsModule.on("changed", ({ active }) => {
            console.log(
              "パンくずリスト(モジュール)の状態が変更されました。アクティブ:",
              active
            );
            if (!active) {
              breadcrumbsShownProcessed = false;
            }
            fitViewportWithDelay();
          });
        } else {
          console.warn("Breadcrumbsモジュールが見つかりませんでした。");
        }
      }

      btnCreateNew.addEventListener("click", async () => {
        clearError();
        if (!modeler) return;
        try {
          const newDiagramXML = initialDiagramXML
            .replace('id="Process_1"', 'id="Process_New"')
            .replace('name="MyProcess"', 'name="新規プロセス"')
            .replace('id="StartEvent_1"', 'id="StartEvent_New"')
            .replace('name="開始"', 'name="新しい開始"');
          await modeler.importXML(newDiagramXML);
          console.log("新しいダイアグラムが作成されました。");
          fitViewport();
          breadcrumbsShownProcessed = false;
        } catch (err) {
          showError(`新規ダイアグラムの作成に失敗: ${err.message || err}`);
        }
      });

      btnExportBpmn.addEventListener("click", async () => {
        clearError();
        if (!modeler) return;
        try {
          const defaultFilename = "diagram.bpmn";
          const filename = window.prompt(
            "BPMNファイル名を入力してください:",
            defaultFilename
          );
          if (filename === null) {
            console.log("BPMNエクスポートがキャンセルされました。");
            return;
          }
          if (filename.trim() === "") {
            showError("ファイル名が空です。");
            return;
          }
          const finalFilename = filename.endsWith(".bpmn")
            ? filename
            : filename + ".bpmn";

          const { xml } = await modeler.saveXML({ format: true });
          downloadFile(finalFilename, xml, "application/xml");
          console.log(
            `BPMN XMLが ${finalFilename} としてエクスポートされました。`
          );
        } catch (err) {
          showError(`BPMNのエクスポートに失敗: ${err.message || err}`);
        }
      });

      btnImportBpmn.addEventListener("click", () => {
        clearError();
        fileInputBpmn.click();
      });

      fileInputBpmn.addEventListener("change", (event) => {
        clearError();
        const file = event.target.files[0];
        if (file && modeler) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            const xml = e.target.result;
            try {
              await modeler.importXML(xml);
              console.log("BPMN XMLが正常にインポートされました。");
              fitViewport();
              breadcrumbsShownProcessed = false;
            } catch (err) {
              showError(
                `BPMNファイルのインポートに失敗: ${err.message || err}`
              );
            }
          };
          reader.onerror = (e) => {
            showError(`ファイルの読み込みに失敗しました。`);
          };
          reader.readAsText(file);
        }
        event.target.value = "";
      });

      btnShowSvg.addEventListener("click", async () => {
        clearError();
        if (!modeler) return;
        try {
          const { svg } = await modeler.saveSVG();
          const svgWindow = window.open("");
          if (svgWindow) {
            svgWindow.document.write(svg);
            svgWindow.document.close();
            console.log("SVGが新しいタブに表示されました。");
          } else {
            showError(
              "新しいタブを開けませんでした。ポップアップブロッカーを確認してください。"
            );
          }
        } catch (err) {
          showError(`SVGの生成または表示に失敗: ${err.message || err}`);
        }
      });

      btnExportSvg.addEventListener("click", async () => {
        clearError();
        if (!modeler) return;
        try {
          const defaultFilename = "diagram.svg";
          const filename = window.prompt(
            "SVGファイル名を入力してください:",
            defaultFilename
          );
          if (filename === null) {
            console.log("SVGエクスポートがキャンセルされました。");
            return;
          }
          if (filename.trim() === "") {
            showError("ファイル名が空です。");
            return;
          }
          const finalFilename = filename.endsWith(".svg")
            ? filename
            : filename + ".svg";

          const { svg } = await modeler.saveSVG();
          downloadFile(finalFilename, svg, "image/svg+xml");
          console.log(`SVGが ${finalFilename} としてエクスポートされました。`);
        } catch (err) {
          showError(`SVGのエクスポートに失敗: ${err.message || err}`);
        }
      });

      document.addEventListener("DOMContentLoaded", initializeModeler);

      window.addEventListener("beforeunload", () => {
        if (djsContainerObserver) {
          djsContainerObserver.disconnect();
          console.log("djs-containerの監視を停止しました。");
        }
      });
    </script>
  </body>
</html>
